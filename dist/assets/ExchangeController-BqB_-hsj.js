import{cD as x,cE as N,cF as E,cG as m,cH as A,cI as P,cJ as I,cK as f,cL as L,cM as C,cN as T,cO as p,cP as b,cQ as S,cR as W,cS as _,cT as v,cU as F}from"./index-p_Z8N9UO.js";const H=0,U={paymentAsset:null,amount:null,tokenAmount:0,priceLoading:!1,error:null,exchanges:[],isLoading:!1,currentPayment:void 0,isPaymentInProgress:!1,paymentId:"",assets:[]},e=x(U),u={state:e,subscribe(s){return F(e,()=>s(e))},subscribeKey(s,t){return v(e,s,t)},resetState(){Object.assign(e,{...U})},async getAssetsForNetwork(s){const t=_(s),n=await u.getAssetsImageAndPrice(t),r=t.map(a=>{var o,l,y,g;const i=a.asset==="native"?S():`${a.network}:${a.asset}`,c=n.find(k=>{var d,h,w;return((w=(h=(d=k.fungibles)==null?void 0:d[0])==null?void 0:h.address)==null?void 0:w.toLowerCase())===i.toLowerCase()});return{...a,price:((l=(o=c==null?void 0:c.fungibles)==null?void 0:o[0])==null?void 0:l.price)||1,metadata:{...a.metadata,iconUrl:(g=(y=c==null?void 0:c.fungibles)==null?void 0:y[0])==null?void 0:g.iconUrl}}});return e.assets=r,r},async getAssetsImageAndPrice(s){const t=s.map(r=>r.asset==="native"?S():`${r.network}:${r.asset}`);return await Promise.all(t.map(r=>W.fetchTokenPrice({addresses:[r]})))},getTokenAmount(){var n;if(!((n=e==null?void 0:e.paymentAsset)!=null&&n.price))throw new Error("Cannot get token price");const s=b.bigNumber(e.amount??0).round(8),t=b.bigNumber(e.paymentAsset.price).round(8);return s.div(t).round(8).toNumber()},setAmount(s){var t;e.amount=s,(t=e.paymentAsset)!=null&&t.price&&(e.tokenAmount=u.getTokenAmount())},setPaymentAsset(s){e.paymentAsset=s},isPayWithExchangeEnabled(){var s,t,n;return((s=p.state.remoteFeatures)==null?void 0:s.payWithExchange)||((t=p.state.remoteFeatures)==null?void 0:t.payments)||((n=p.state.features)==null?void 0:n.pay)},isPayWithExchangeSupported(){return u.isPayWithExchangeEnabled()&&C.state.activeCaipNetwork&&T.PAY_WITH_EXCHANGE_SUPPORTED_CHAIN_NAMESPACES.includes(C.state.activeCaipNetwork.chainNamespace)},async fetchExchanges(){var s;try{const t=u.isPayWithExchangeSupported();if(!e.paymentAsset||!t){e.exchanges=[],e.isLoading=!1;return}e.isLoading=!0;const n=await L({page:H,asset:f(e.paymentAsset.network,e.paymentAsset.asset),amount:((s=e.amount)==null?void 0:s.toString())??"0"});e.exchanges=n.exchanges.slice(0,2)}catch{throw P.showError("Unable to get exchanges"),new Error("Unable to get exchanges")}finally{e.isLoading=!1}},async getPayUrl(s,t){try{const n=Number(t.amount),r=await I({exchangeId:s,asset:f(t.network,t.asset),amount:n.toString(),recipient:`${t.network}:${t.recipient}`});return E.sendEvent({type:"track",event:"PAY_EXCHANGE_SELECTED",properties:{exchange:{id:s},configuration:{network:t.network,asset:t.asset,recipient:t.recipient,amount:n},currentPayment:{type:"exchange",exchangeId:s},source:"fund-from-exchange",headless:!1}}),r}catch(n){throw n instanceof Error&&n.message.includes("is not supported")?new Error("Asset not supported"):new Error(n.message)}},async handlePayWithExchange(s){try{if(!m.state.address)throw new Error("No account connected");if(!e.paymentAsset)throw new Error("No payment asset selected");const t=A.returnOpenHref("","popupWindow","scrollbar=yes,width=480,height=720");if(!t)throw new Error("Could not create popup window");e.isPaymentInProgress=!0,e.paymentId=crypto.randomUUID(),e.currentPayment={type:"exchange",exchangeId:s};const{network:n,asset:r}=e.paymentAsset,a={network:n,asset:r,amount:e.tokenAmount,recipient:m.state.address},i=await u.getPayUrl(s,a);if(!i){try{t.close()}catch(c){console.error("Unable to close popup window",c)}throw new Error("Unable to initiate payment")}e.currentPayment.sessionId=i.sessionId,e.currentPayment.status="IN_PROGRESS",e.currentPayment.exchangeId=s,t.location.href=i.url}catch{e.error="Unable to initiate payment",P.showError(e.error)}},async waitUntilComplete({exchangeId:s,sessionId:t,paymentId:n,retries:r=20}){const a=await u.getBuyStatus(s,t,n);if(a.status==="SUCCESS"||a.status==="FAILED")return a;if(r===0)throw new Error("Unable to get deposit status");return await new Promise(i=>{setTimeout(i,5e3)}),u.waitUntilComplete({exchangeId:s,sessionId:t,paymentId:n,retries:r-1})},async getBuyStatus(s,t,n){var r,a,i,c;try{if(!e.currentPayment)throw new Error("No current payment");const o=await N({sessionId:t,exchangeId:s});return e.currentPayment.status=o.status,(o.status==="SUCCESS"||o.status==="FAILED")&&(e.currentPayment.result=o.txHash,e.isPaymentInProgress=!1,E.sendEvent({type:"track",event:o.status==="SUCCESS"?"PAY_SUCCESS":"PAY_ERROR",properties:{message:o.status==="FAILED"?A.parseError(e.error):void 0,source:"fund-from-exchange",paymentId:n,configuration:{network:((r=e.paymentAsset)==null?void 0:r.network)||"",asset:((a=e.paymentAsset)==null?void 0:a.asset)||"",recipient:m.state.address||"",amount:e.amount??0},currentPayment:{type:"exchange",exchangeId:(i=e.currentPayment)==null?void 0:i.exchangeId,sessionId:(c=e.currentPayment)==null?void 0:c.sessionId,result:o.txHash}}})),o}catch{return{status:"UNKNOWN",txHash:""}}},reset(){e.currentPayment=void 0,e.isPaymentInProgress=!1,e.paymentId="",e.paymentAsset=null,e.amount=0,e.tokenAmount=0,e.priceLoading=!1,e.error=null,e.exchanges=[],e.isLoading=!1}};export{u as E};
